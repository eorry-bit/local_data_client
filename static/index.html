<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¥æµ‹æ•°æ®å¯è§†åŒ–é¢æ¿</title>
    <script src="libs/plotly.min.js"></script>
    <script src="libs/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        /* å¯æœç´¢ä¸‹æ‹‰æ¡†æ ·å¼ */
        .searchable-select {
            position: relative;
            width: 100%;
        }
        
        .searchable-select-input {
            width: 100%;
            padding: 8px 30px 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            position: relative;
        }
        
        .searchable-select-input::after {
            content: 'â–¼';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #666;
        }
        
        .searchable-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .searchable-select-dropdown.show {
            display: block;
        }
        
        .searchable-select-search {
            padding: 8px;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }
        
        .searchable-select-search input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .searchable-select-options {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .searchable-select-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .searchable-select-option:hover {
            background: #f0f0f0;
        }
        
        .searchable-select-option.selected {
            background: #e8f4fd;
            font-weight: 500;
        }
        
        .searchable-select-no-results {
            padding: 12px;
            text-align: center;
            color: #999;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 300;
        }
        
        .controls {
            padding: 20px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .control-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-icon {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .collapsible-section {
            cursor: pointer;
            user-select: none;
        }
        
        .section-content {
            transition: all 0.3s ease;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .action-buttons .btn {
            background: white;
            color: #667eea;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: #28a745 !important;
            color: white !important;
        }
        
        .btn-export {
            background: #17a2b8 !important;
            color: white !important;
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        .filter-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .target-selection {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .target-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 120px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }
        
        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            font-size: 13px;
        }
        
        .time-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .chart-container {
            padding: 20px;
            min-height: 600px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .data-stats {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-size: 14px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .stats-row:last-child {
            margin-bottom: 0;
        }

        .stats-label {
            font-weight: 500;
            color: #495057;
        }

        .stats-value {
            color: #007bff;
            font-weight: 600;
        }

        .outlier-removed {
            color: #dc3545;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal-content-large {
            max-width: 900px !important;
            max-height: 90vh !important;
            display: flex !important;
            flex-direction: column !important;
            margin: 2% auto !important;
        }
        
        .modal-body-scrollable {
            overflow-y: auto !important;
            flex: 1 !important;
            max-height: calc(90vh - 120px) !important;
            padding: 20px;
        }

        .modal-header {
            padding: 20px;
            background-color: #667eea;
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #ddd;
            text-align: right;
        }

        .reference-value-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .reference-value-item input,
        .reference-value-item select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .remove-btn:hover {
            background-color: #c82333;
        }
        
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .time-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>é¥æµ‹æ•°æ®å¯è§†åŒ–é¢æ¿</h1>
        </div>
        
        <div class="controls">
            <!-- æ•°æ®é€‰æ‹©åŒºåŸŸ -->
            <div class="control-section">
                <div class="section-title">
                    <span class="section-icon">ğŸ“Š</span>
                    <span>æ•°æ®é€‰æ‹©</span>
                </div>
                <div class="filter-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="filter-group">
                        <label>èµ„äº§åç§°:</label>
                        <div id="mainAssetContainer"></div>
                    </div>
                    
                    <div class="filter-group">
                        <label>è®¾å¤‡åç§°:</label>
                        <div id="mainDeviceContainer"></div>
                    </div>
                    
                    <div class="filter-group">
                        <label>æ ‡é¶é€‰æ‹© (å¯å¤šé€‰):</label>
                        <div id="mainTargetContainer"></div>
                    </div>
                    
                    <div class="filter-group">
                        <label>æ•°æ®ç±»å‹ (å¯å¤šé€‰):</label>
                        <div id="mainKeyNameContainer"></div>
                    </div>
                </div>
            </div>
            
            <!-- æ•°æ®è¿‡æ»¤åŒºåŸŸ -->
            <div class="control-section">
                <div class="section-title collapsible-section" onclick="toggleSection('filterSection')">
                    <span id="filterSectionToggle" style="width: 20px;">â–¼</span>
                    <span class="section-icon">ğŸ”§</span>
                    <span>æ•°æ®è¿‡æ»¤é€‰é¡¹</span>
                </div>
                <div id="filterSection" class="section-content">
                    <div class="filter-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div class="filter-group">
                            <label>
                                <input type="checkbox" id="removeOutliers"> å»é™¤å¼‚å¸¸æ•°æ®
                            </label>
                            <select id="outlierMethod" disabled style="margin-top: 5px; width: 100%;">
                                <option value="iqr">IQRæ–¹æ³• (å››åˆ†ä½è·)</option>
                                <option value="zscore">Z-Scoreæ–¹æ³• (æ ‡å‡†å·®)</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>
                                <input type="checkbox" id="enableTimeFilter"> æ¯æ—¥æ—¶é—´æ®µè¿‡æ»¤
                            </label>
                            <button class="btn" onclick="showTimeRangeModal()" id="configTimeRanges" disabled style="margin-top: 5px; width: 100%;">é…ç½®æ—¶é—´æ®µ</button>
                        </div>
                    </div>
                    
                    <div class="filter-row" style="margin-top: 15px;">
                        <div class="filter-group">
                            <label>
                                <input type="checkbox" id="enableCustomFilter"> è‡ªå®šä¹‰æ•°å€¼è¿‡æ»¤
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                        <div class="filter-group">
                            <label for="minValue">æœ€å°å€¼:</label>
                            <input type="number" id="minValue" step="any" placeholder="ä¾‹å¦‚: -1000" disabled>
                        </div>

                        <div class="filter-group">
                            <label for="maxValue">æœ€å¤§å€¼:</label>
                            <input type="number" id="maxValue" step="any" placeholder="ä¾‹å¦‚: 1000" disabled>
                        </div>

                        <div class="filter-group">
                            <label for="excludeValues">æ’é™¤å€¼:</label>
                            <input type="text" id="excludeValues" placeholder="ä¾‹å¦‚: 0,999,9999" disabled>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ€§èƒ½ä¼˜åŒ–åŒºåŸŸ -->
            <div class="control-section">
                <div class="section-title collapsible-section" onclick="toggleSection('performanceSection')">
                    <span id="performanceSectionToggle" style="width: 20px;">â–¼</span>
                    <span class="section-icon">âš¡</span>
                    <span>æ€§èƒ½ä¼˜åŒ–é€‰é¡¹</span>
                </div>
                <div id="performanceSection" class="section-content">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>
                                <input type="checkbox" id="enablePerformanceMode"> å¯ç”¨æ•°æ®èšåˆæ¨¡å¼
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                        <div class="filter-group">
                            <label for="dataLimit">æ•°æ®ç‚¹é™åˆ¶:</label>
                            <select id="dataLimit" disabled>
                                <option value="10000">1ä¸‡ç‚¹ (æ¨è)</option>
                                <option value="50000">5ä¸‡ç‚¹</option>
                                <option value="100000">10ä¸‡ç‚¹</option>
                                <option value="500000">50ä¸‡ç‚¹</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="samplingInterval">èšåˆæ—¶é—´çª—å£:</label>
                            <select id="samplingInterval" disabled>
                                <option value="">ä¸èšåˆ</option>
                                <option value="1000">1ç§’</option>
                                <option value="5000">5ç§’</option>
                                <option value="10000">10ç§’</option>
                                <option value="30000">30ç§’</option>
                                <option value="60000">1åˆ†é’Ÿ</option>
                                <option value="300000">5åˆ†é’Ÿ</option>
                                <option value="600000">10åˆ†é’Ÿ</option>
                                <option value="1800000">30åˆ†é’Ÿ</option>
                                <option value="3600000">1å°æ—¶</option>
                                <option value="7200000">2å°æ—¶</option>
                                <option value="14400000">4å°æ—¶</option>
                                <option value="21600000">6å°æ—¶</option>
                                <option value="36000000">10å°æ—¶</option>
                                <option value="43200000">12å°æ—¶</option>
                                <option value="86400000">1å¤©</option>
                                <option value="259200000">3å¤©</option>
                                <option value="604800000">1å‘¨</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="samplingMethod">èšåˆæ–¹æ³•:</label>
                            <select id="samplingMethod" disabled>
                                <option value="first">ç¬¬ä¸€ä¸ªå€¼ (First)</option>
                                <option value="last">æœ€åä¸€ä¸ªå€¼ (Last)</option>
                                <option value="avg">å¹³å‡å€¼ (Average)</option>
                                <option value="max">æœ€å¤§å€¼ (Maximum)</option>
                                <option value="min">æœ€å°å€¼ (Minimum)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
            <div class="control-section">
                <div class="section-title">
                    <span class="section-icon">â°</span>
                    <span>æ—¶é—´èŒƒå›´</span>
                </div>
                <div class="filter-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="filter-group">
                        <label for="startTime">å¼€å§‹æ—¶é—´:</label>
                        <input type="datetime-local" id="startTime" style="width: 100%;">
                    </div>
                    
                    <div class="filter-group">
                        <label for="endTime">ç»“æŸæ—¶é—´:</label>
                        <input type="datetime-local" id="endTime" style="width: 100%;">
                    </div>
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="loadData()">ğŸ” æŸ¥è¯¢æ•°æ®</button>
                <button class="btn btn-primary" onclick="loadDataStream()">ğŸ“¡ æµå¼åŠ è½½</button>
                <button class="btn" onclick="clearChart()">ğŸ—‘ï¸ æ¸…ç©ºå›¾è¡¨</button>
                <button class="btn btn-export" onclick="exportToExcel()" id="exportBtn" disabled>ğŸ“Š å¯¼å‡ºExcel</button>
                <button class="btn btn-export" onclick="exportToHTML()" id="exportHTMLBtn" disabled>ğŸ“ˆ å¯¼å‡ºHTML</button>
                <button class="btn" onclick="showReferenceValueModal()">ğŸ“ è®¾ç½®å‚è€ƒå€¼</button>
                <button class="btn" onclick="showDataOperationsModal()">âš™ï¸ æ•°æ®æ“ä½œ</button>
            </div>
        </div>
        
        <div class="chart-container">
            <div id="dataStats" class="data-stats" style="display: none;">
                <div class="stats-row">
                    <span class="stats-label">æ•°æ®ç‚¹æ€»æ•°:</span>
                    <span class="stats-value" id="totalDataPoints">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">æ—¶é—´èŒƒå›´:</span>
                    <span class="stats-value" id="timeRange">-</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">æ ‡é¶æ•°é‡:</span>
                    <span class="stats-value" id="targetCount">0</span>
                </div>
                <div id="outlierStats" style="display: none;">
                    <div class="stats-row">
                        <span class="stats-label">å¼‚å¸¸å€¼æ£€æµ‹:</span>
                        <span class="stats-value" id="outlierMethod">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">ç§»é™¤å¼‚å¸¸å€¼:</span>
                        <span class="stats-value outlier-removed" id="removedOutliers">0</span>
                    </div>
                </div>
            </div>

            <div id="chart" style="width: 100%; height: 600px;"></div>
            <div id="loading" class="loading" style="display: none;">
                <span class="loading-spinner"></span>æ­£åœ¨åŠ è½½æ•°æ®...
            </div>
            <div id="info" class="info" style="display: none; background-color: #d4edda; color: #155724; padding: 10px; margin: 10px 0; border-radius: 4px;"></div>
            <div id="error" class="error" style="display: none;"></div>
        </div>
    </div>

    <!-- å‚è€ƒå€¼é…ç½®æ¨¡æ€æ¡† -->
    <div id="referenceValueModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è®¾ç½®å‚è€ƒå€¼</h3>
                <span class="close" onclick="hideReferenceValueModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>ä¸ºä¸åŒæ ‡é¶çš„ä¸åŒæŒ‡æ ‡è®¾ç½®å‚è€ƒå€¼ï¼ŒæŸ¥è¯¢æ—¶å°†è‡ªåŠ¨å‡å»å‚è€ƒå€¼æ˜¾ç¤ºç›¸å¯¹å˜åŒ–ï¼š</p>
                <div id="referenceValueList">
                    <!-- å‚è€ƒå€¼é…ç½®é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button class="btn" onclick="addReferenceValue()">æ·»åŠ å‚è€ƒå€¼</button>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveReferenceValues()">ä¿å­˜</button>
                <button class="btn" onclick="hideReferenceValueModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ—¶é—´æ®µé…ç½®æ¨¡æ€æ¡† -->
    <div id="timeRangeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>é…ç½®æ¯æ—¥æ—¶é—´æ®µ</h3>
                <span class="close" onclick="hideTimeRangeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>è®¾ç½®å¤šä¸ªæ—¶é—´æ®µï¼ŒåªæŸ¥è¯¢è¿™äº›æ—¶é—´æ®µå†…çš„æ•°æ®ï¼š</p>
                <div id="timeRangeList">
                    <!-- æ—¶é—´æ®µé…ç½®é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button class="btn" onclick="addTimeRange()">æ·»åŠ æ—¶é—´æ®µ</button>
                <div style="margin-top: 15px;">
                    <h4>å¸¸ç”¨é¢„è®¾ï¼š</h4>
                    <button class="btn" onclick="setPresetTimeRanges('work')">å·¥ä½œæ—¶é—´ (9:00-12:00, 14:00-18:00)</button>
                    <button class="btn" onclick="setPresetTimeRanges('peak')">é«˜å³°æ—¶æ®µ (8:00-10:00, 17:00-19:00)</button>
                    <button class="btn" onclick="setPresetTimeRanges('night')">å¤œé—´æ—¶æ®µ (22:00-06:00)</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveTimeRanges()">ä¿å­˜</button>
                <button class="btn" onclick="hideTimeRangeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ•°æ®æ“ä½œç®¡ç†æ¨¡æ€æ¡† -->
    <div id="dataOperationsModal" class="modal" style="display: none;">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h3>æ•°æ®æ“ä½œç®¡ç†</h3>
                <span class="close" onclick="hideDataOperationsModal()">&times;</span>
            </div>
            <div class="modal-body modal-body-scrollable">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <button class="btn btn-primary" onclick="showAddOperationForm()">æ–°å¢æ“ä½œ</button>
                            <button class="btn" onclick="refreshOperationsList()">åˆ·æ–°åˆ—è¡¨</button>
                            <button class="btn" onclick="exportOperations()">å¯¼å‡ºæ“ä½œ</button>
                            <button class="btn" onclick="showImportDialog()">å¯¼å…¥æ“ä½œ</button>
                            <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImportFile(event)" multiple>
                        </div>
                        
                        <!-- æœç´¢ç­›é€‰åŒºåŸŸ -->
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="operationsSearchInput" placeholder="æœç´¢æ ‡é¶ã€æŒ‡æ ‡æˆ–æ“ä½œåç§°..." 
                                   style="width: 250px; padding: 6px;" onkeyup="filterOperations()">
                            <select id="operationsFilterType" onchange="filterOperations()" style="padding: 6px;">
                                <option value="">æ‰€æœ‰æ“ä½œç±»å‹</option>
                                <option value="Add">åŠ æ³• (+)</option>
                                <option value="Subtract">å‡æ³• (-)</option>
                                <option value="Multiply">ä¹˜æ³• (Ã—)</option>
                                <option value="Divide">é™¤æ³• (Ã·)</option>
                            </select>
                            <select id="operationsFilterStatus" onchange="filterOperations()" style="padding: 6px;">
                                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                                <option value="active">å¯ç”¨</option>
                                <option value="inactive">åœç”¨</option>
                            </select>
                            <button class="btn" onclick="clearOperationsFilter()" style="padding: 6px 12px; background: #dc3545;">æ¸…é™¤ç­›é€‰</button>
                        </div>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿæ·»åŠ æ“ä½œè¡¨å• -->
                <div id="quickAddForm" style="background: #f0f8ff; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 14px; cursor: pointer; user-select: none;" onclick="toggleQuickForm()">
                        <span id="quickFormToggle" style="margin-right: 5px;">â–¼</span>å¿«é€Ÿæ·»åŠ /ç¼–è¾‘æ“ä½œ
                    </h4>
                    <div id="quickFormContent">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 10px;">
                            <div id="quickAssetContainer"></div>
                            <div id="quickDeviceContainer"></div>
                            <div id="quickTargetContainer"></div>
                            <div id="quickKeyContainer"></div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="quickOperation" style="width: 60px;">
                                <option value="add">+</option>
                                <option value="subtract">-</option>
                                <option value="multiply">Ã—</option>
                                <option value="divide">Ã·</option>
                            </select>
                            <input type="number" id="quickValue" step="any" placeholder="æ•°å€¼" style="width: 100px;">
                            <button class="btn btn-primary" onclick="quickAddOperation()" style="padding: 5px 15px;">å¿«é€Ÿæ·»åŠ </button>
                            <button class="btn" onclick="toggleAdvancedForm()" style="padding: 5px 10px;">é«˜çº§é€‰é¡¹</button>
                        </div>
                    </div>
                </div>
                
                <!-- é«˜çº§é€‰é¡¹è¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <div id="advancedForm" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 id="operationFormTitle">é«˜çº§è®¾ç½®</h4>
                    <input type="hidden" id="operationId">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>è‡ªå®šä¹‰åç§° (å¯é€‰):</label>
                            <input type="text" id="operationName" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ" style="width: 100%;">
                        </div>
                        <div>
                            <label>æè¿° (å¯é€‰):</label>
                            <input type="text" id="operationDescription" placeholder="å¯é€‰æè¿°" style="width: 100%;">
                        </div>
                        <div>
                            <label>å¼€å§‹æ—¶é—´ (å¯é€‰):</label>
                            <input type="datetime-local" id="operationStartTime" style="width: 100%;">
                        </div>
                        <div>
                            <label>ç»“æŸæ—¶é—´ (å¯é€‰):</label>
                            <input type="datetime-local" id="operationEndTime" style="width: 100%;">
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="saveAdvancedOperation()">ä¿å­˜</button>
                        <button class="btn" onclick="hideAdvancedForm()">å–æ¶ˆ</button>
                    </div>
                </div>
                
                <!-- æ“ä½œåˆ—è¡¨ -->
                <div id="operationsList" style="display: flex; flex-direction: column; min-height: 300px;">
                    <div style="flex: 1; overflow-y: auto; max-height: 350px; min-height: 200px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background: #f5f5f5; position: sticky; top: 0; z-index: 10;">
                                    <th style="padding: 8px 5px; text-align: center; border-bottom: 2px solid #ddd; width: 40px;">å¯ç”¨</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">æ“ä½œ</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">æ ‡é¶</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">æŒ‡æ ‡</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd; width: 120px;">å¿«æ·æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="operationsTableBody">
                                <tr>
                                    <td colspan="5" style="padding: 20px; text-align: center; color: #999;">æ­£åœ¨åŠ è½½...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åˆ†é¡µæ§ä»¶ -->
                    <div id="operationsPagination" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-top: 1px solid #ddd; background: #f9f9f9;">
                        <div>
                            <span>æ¯é¡µæ˜¾ç¤º: </span>
                            <select id="operationsPageSize" onchange="changeOperationsPageSize()" style="padding: 4px;">
                                <option value="10">10æ¡</option>
                                <option value="20" selected>20æ¡</option>
                                <option value="50">50æ¡</option>
                                <option value="100">100æ¡</option>
                            </select>
                            <span style="margin-left: 10px;">å…± <span id="operationsTotalCount">0</span> æ¡è®°å½•</span>
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button class="btn" onclick="firstPageOperations()" style="padding: 4px 8px; font-size: 12px; background: #6c757d;">é¦–é¡µ</button>
                            <button class="btn" onclick="prevPageOperations()" style="padding: 4px 8px; font-size: 12px; background: #6c757d;">ä¸Šä¸€é¡µ</button>
                            <span>ç¬¬ <input type="number" id="operationsCurrentPage" value="1" min="1" style="width: 50px; padding: 2px; text-align: center;" onchange="goToPageOperations()"> / <span id="operationsTotalPages">1</span> é¡µ</span>
                            <button class="btn" onclick="nextPageOperations()" style="padding: 4px 8px; font-size: 12px; background: #6c757d;">ä¸‹ä¸€é¡µ</button>
                            <button class="btn" onclick="lastPageOperations()" style="padding: 4px 8px; font-size: 12px; background: #6c757d;">æœ«é¡µ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HTMLå¯¼å‡ºæ ‡é¢˜ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="exportHTMLModal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header">
                <h2>å¯¼å‡ºHTMLæŠ¥å‘Šè®¾ç½®</h2>
                <span class="close" onclick="hideExportHTMLModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label for="chartTitle">å›¾è¡¨æ ‡é¢˜ï¼š</label>
                    <input type="text" id="chartTitle" style="width: 100%; margin-top: 10px;" 
                           placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰æ ‡é¢˜ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤æ ‡é¢˜ï¼‰">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        é»˜è®¤æ ‡é¢˜æ ¼å¼ï¼šèµ„äº§å - è®¾å¤‡å - [æŒ‡æ ‡åˆ—è¡¨]
                    </small>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label for="reportTitle">æŠ¥å‘Šä¸»æ ‡é¢˜ï¼š</label>
                    <input type="text" id="reportTitle" value="ä½ç§»æ•°æ®åˆ†ææŠ¥å‘Š"
                           style="width: 100%; margin-top: 10px;">
                </div>
                
                <div class="filter-group">
                    <label for="reportDescription">æŠ¥å‘Šæè¿°ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <textarea id="reportDescription" rows="3" 
                              style="width: 100%; margin-top: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                              placeholder="å¯ä»¥æ·»åŠ ä¸€äº›å¤‡æ³¨è¯´æ˜..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="confirmExportHTML()" style="background-color: #17a2b8;">ç¡®è®¤å¯¼å‡º</button>
                <button class="btn" onclick="hideExportHTMLModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="libs/plotly.min.js"></script>
    <script src="libs/xlsx.full.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
